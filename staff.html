<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pet Capstone - Staff Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>.inter-font { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="inter-font bg-gray-50 min-h-screen flex flex-col items-center p-4 sm:p-8">

  <div id="result" class="fixed top-0 inset-x-0 bg-opacity-90 py-3 text-center transition-all duration-300 transform -translate-y-full" style="z-index:100;"></div>

  <div class="w-full max-w-4xl">
    <h1 class="text-4xl font-bold text-center text-indigo-700 mb-8">Staff Dashboard</h1>

    <div id="dashboardSection" class="space-y-8">
      <div class="flex justify-between items-center bg-white p-6 rounded-xl shadow-lg">
        <p id="userStatus" class="text-lg font-medium text-gray-700"></p>
        <button id="logoutBtn" class="bg-red-500 text-white p-3 rounded-lg hover:bg-red-600">Sign Out</button>
      </div>

      <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
        <h2 class="text-2xl font-bold mb-4">Add New Pet</h2>
        <form id="addPetForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <input type="text" id="petName" placeholder="Name" class="border rounded p-2 w-full" required>
          <input type="text" id="petBreed" placeholder="Breed" class="border rounded p-2 w-full">
          <input type="number" id="petAge" placeholder="Age" class="border rounded p-2 w-full">
          <select id="petGender" class="border rounded p-2 w-full">
            <option value="">Select Gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
          </select>
          <select id="petEnergy" class="border rounded p-2 w-full">
            <option value="">Energy Level</option>
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
          </select>
          <input type="text" id="petTemperament" placeholder="Temperament" class="border rounded p-2 w-full">
        <select id="petOrg" class="border rounded p-2 w-full" required>
          <option value="">Select Organization</option>
        </select>
          <button type="submit" class="col-span-1 sm:col-span-2 bg-green-600 text-white p-3 rounded-lg hover:bg-green-700">Add Pet</button>

        </form>
      </div>

    <div id="dynamicDashboard" class="bg-white p-6 rounded-xl shadow-lg min-h-[400px]"></div>
     
      <p id="debugToken" class="text-xs text-gray-500">Token: <span id="tokenDisplay"></span></p>
      <div id="staffRequests" class="space-y-4"></div>
    </div>
  </div>

  <script>
    const API_BASE_URL = "http://localhost:5001/api/auth";
    const PETS_API_URL = "http://localhost:5001/api/pets";
    const STAFF_API_URL = "http://localhost:5001/api/users";
    // NEW: Adoption API base URL
    const ADOPTIONS_API_URL = "http://localhost:5001/api/adoptions";
    // For updateRequestStatus:
    const ADOPTION_API_BASE_URL = "http://localhost:5001/api/adoptions"; 

    let token = localStorage.getItem("token");

    const displayMessage = (msg, err=false)=>{
      const r=document.getElementById("result");
      r.innerText=msg;
      r.className=`fixed top-0 inset-x-0 py-3 text-center transform translate-y-0 ${err?'bg-red-500':'bg-green-500'} text-white`;
      clearTimeout(window.msgTimeout);
      window.msgTimeout=setTimeout(()=>{r.classList.add("-translate-y-full")},4000);
    };

    const fetchWithAuth = (url,opt={})=>{
      return fetch(url,{...opt,headers:{'Content-Type':'application/json','x-auth-token':token,...opt.headers}});
    };

    const setViewState = (logged,user)=>{
      if(logged){
        document.getElementById("tokenDisplay").innerText=token.substring(0,25)+"...";
        document.getElementById("userStatus").innerHTML=`Welcome <b>${user.name}</b> (Role: ${user.role})`;
        renderDashboard(user);
      } else {
        localStorage.removeItem("token");
        token=null;
        window.location.href = "index.html"; // redirect to login
      }
    };

    const loadUserAndDashboard = async () => {
      if(!token){ setViewState(false); return; }
      try {
        const res = await fetchWithAuth(`${API_BASE_URL}/me`);
        const user = await res.json();
        if(res.ok) {
          setViewState(true, user);
          await loadStaffRequests(); 
        }
        else { displayMessage(user.msg||"Session expired", true); setViewState(false); }
      } catch {
        displayMessage("Server error", true);
        setViewState(false);
      }
    };

    // ------------------------
    // Dashboard rendering for Staff
    // ------------------------
    const renderDashboard = async (user) => {
      const dash = document.getElementById("dynamicDashboard");

      try {
        const res = await fetchWithAuth(PETS_API_URL);
        const pets = await res.json();
        if(!res.ok) throw new Error("Failed to fetch pets");

        dash.innerHTML = `
          <h2 class="text-2xl font-bold mb-4">All Pets</h2>
          <div id="petsList" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        `;

        const petsList = document.getElementById("petsList");
        if(!petsList) return;

        if(pets.length > 0){
          petsList.innerHTML = pets.map(pet => `
            <div class="bg-white border rounded-xl shadow-md overflow-hidden p-4">
              ${pet.images && pet.images[0]? `<img src="${pet.images[0]}" class="w-full h-48 object-cover mb-2">`
              : `<div class="w-full h-48 flex items-center justify-center bg-gray-200 text-gray-500 mb-2">No Image</div>`}
              <h3 class="text-lg font-semibold text-indigo-700">${pet.name}</h3>
              <p class="text-sm text-gray-600">Breed: ${pet.breed || "Unknown"}</p>
              <p class="text-sm text-gray-600">Energy: ${pet.energyLevel || "N/A"}</p>
              <p class="text-sm text-gray-600">Status: ${pet.status}</p>
              <p class="text-sm text-gray-600">Adopter: ${pet.adopter ? pet.adopter.name : "None"}</p>
              <p class="text-sm text-gray-600">Vet: ${pet.vet ? pet.vet.name : "None"}</p>

              <div class="mt-2">
                <select id="vetSelect-${pet._id}" class="border rounded p-1 text-sm w-full mb-1">
                  <option value="">Assign Vet</option>
                </select>
                <button onclick="assignVet('${pet._id}')" class="px-3 py-1 bg-blue-600 text-white text-sm rounded w-full">Assign</button>
                <button onclick="deletePet('${pet._id}')" class="mt-2 px-3 py-1 bg-red-600 text-white text-sm rounded w-full">Delete Pet</button>

                <select id="statusSelect-${pet._id}" class="border rounded p-1 text-sm w-full mt-2">
                  <option value="">Update Status</option>
                  <option value="Available">Available</option>
                  <option value="In Treatment">In Treatment</option>
                  <option value="Recovered">Recovered</option>
                  <option value="Ready for Adoption">Ready for Adoption</option>
                </select>
                <button onclick="updatePetStatus('${pet._id}')" class="mt-1 px-3 py-1 bg-green-600 text-white text-sm rounded w-full">
                  Update Status
                </button>
              </div>
            </div>
          `).join("");
          
          // Load vets for assignment
          await loadVetsForAssignment(pets);

        } else { 
          petsList.innerHTML = `<p class="col-span-3 text-center text-gray-500">No pets available</p>`;
        }

      } catch(err){
        console.error(err);
        displayMessage("Failed to load pets", true);
      }
    }; 

    // ------------------------
    // Vet assignment
    // ------------------------
    const loadVetsForAssignment = async (pets) => {
      try {
        const res = await fetchWithAuth(`${STAFF_API_URL}/vets`);
        const vets = await res.json();
        if(!res.ok) throw new Error("Failed to fetch vets");

        pets.forEach(pet=>{
          const sel = document.getElementById(`vetSelect-${pet._id}`);
          if (sel) {
            vets.forEach(vet=> {
              const option = document.createElement("option");
              option.value = vet._id;
              option.text = vet.name;
              sel.appendChild(option);
            });
          }
        });
      } catch(err){
        console.error(err);
      }
    };

    const assignVet = async(petId)=>{
      const sel = document.getElementById(`vetSelect-${petId}`);
      const vetId = sel.value;
      if(!vetId) return alert("Select a vet first");

      try {
        const res = await fetchWithAuth(`${PETS_API_URL}/${petId}/assign-vet`,{
          method:"PATCH",
          body: JSON.stringify({vetId})
        });
        const data = await res.json();
        if(res.ok) {displayMessage("Vet assigned successfully"); await loadUserAndDashboard();}
        else displayMessage(data.msg||"Assignment failed",true);
      } catch(err){displayMessage("Server error",true);}
    };

    // delete pet logic
    const deletePet = async (petId) => {
      if(!confirm("Are you sure you want to delete this pet?")) return;

      try {
        const res = await fetchWithAuth(`${PETS_API_URL}/${petId}`, { method: 'DELETE' });
        const data = await res.json();
        if(res.ok){
          displayMessage(data.msg || "Pet deleted successfully");
          await loadUserAndDashboard();
        } else displayMessage(data.msg || "Failed to delete pet", true);
      } catch(err){
        console.error(err);
        displayMessage("Server error", true);
      }
    };
       
    // organization fetching
    // ------------------------
    // Load Organizations for Add-Pet Form
    // ------------------------
    const loadOrganizations = async () => {
      try {
        const res = await fetchWithAuth("http://localhost:5001/api/organizations");
        const orgs = await res.json();
        if(!res.ok) throw new Error("Failed to fetch organizations");

        const orgSelect = document.getElementById("petOrg");
        orgs.forEach(org => {
          const option = document.createElement("option");
          option.value = org._id;
          option.text = org.name;
          orgSelect.appendChild(option);
        });
      } catch(err){
        console.error(err);
      }
    };


    // Open Edit form and prefill
    const openEditPetForm = (pet) => {
      document.getElementById('petName').value = pet.name;
      document.getElementById('petBreed').value = pet.breed || '';
      document.getElementById('petAge').value = pet.age || '';
      document.getElementById('petGender').value = pet.gender || '';
      document.getElementById('petEnergy').value = pet.energyLevel || '';
      document.getElementById('petTemperament').value = pet.temperament || '';
      document.getElementById('petOrg').value = pet.organization?._id || '';
      
      // Add hidden input for pet ID to distinguish Add vs Edit
      document.getElementById('addPetForm').dataset.editing = pet._id;
    };

    // Submit handler (for Add and Edit Pet)
    const addPetForm = document.getElementById('addPetForm');
    addPetForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const petData = {
        name: document.getElementById('petName').value,
        breed: document.getElementById('petBreed').value,
        age: document.getElementById('petAge').value,
        gender: document.getElementById('petGender').value,
        energyLevel: document.getElementById('petEnergy').value,
        temperament: document.getElementById('petTemperament').value,
        organization: document.getElementById('petOrg').value
      };

      const editingPetId = addPetForm.dataset.editing;

      try {
        let res, data;
        if(editingPetId){
          // EDIT PET
          res = await fetchWithAuth(`${PETS_API_URL}/${editingPetId}`, {
            method: 'PATCH',
            body: JSON.stringify(petData)
          });
          data = await res.json();
          if(res.ok) {
            displayMessage("Pet updated successfully");
            addPetForm.reset();
            delete addPetForm.dataset.editing; // clear editing state
            await loadUserAndDashboard();
          } else displayMessage(data.msg || "Failed to update pet", true);
        } else {
          // ADD PET 
          res = await fetchWithAuth(PETS_API_URL, {
            method: 'POST',
            body: JSON.stringify(petData)
          });
          data = await res.json();
          if(res.ok){
            displayMessage("Pet added successfully");
            addPetForm.reset();
            await loadUserAndDashboard();
          } else displayMessage(data.msg || "Failed to add pet", true);
        }
      } catch(err){
        console.error(err);
        displayMessage("Server error", true);
      }
    });

    // Load organizations when DOM is ready
    document.addEventListener("DOMContentLoaded", loadOrganizations);


    // Update pet status (Global scope)
    async function updatePetStatus(petId) {
      const sel = document.getElementById(`statusSelect-${petId}`);
      const newStatus = sel.value;
      if (!newStatus) return alert("Please select a status");

      try {
        const res = await fetchWithAuth(`http://localhost:5001/api/pets/${petId}/status`, {
          method: "PATCH",
          body: JSON.stringify({ status: newStatus })
        });
        const data = await res.json();
        if (res.ok) {
          displayMessage(`Status updated to ${newStatus}`);
          await loadUserAndDashboard(); // refresh UI
        } else {
          displayMessage(data.msg || "Failed to update status", true);
        }
      } catch (err) {
        console.error(err);
        displayMessage("Server error", true);
      }
    }


    // fetch adoption requests for staff
    const loadStaffRequests = async () => {
      try {
        const res = await fetchWithAuth(`${ADOPTIONS_API_URL}/requests`);
        const requests = await res.json();
        if (!res.ok) throw new Error("Failed to load requests");

        const container = document.getElementById('staffRequests');
        if(requests.length === 0){
          container.innerHTML = `<h2 class="text-2xl font-bold mb-4">Adoption Requests</h2><p class="text-gray-500">No adoption requests</p>`;
          return;
        }

        container.innerHTML = `
          <h2 class="text-2xl font-bold mb-4">Adoption Requests</h2>
          <div class="space-y-4">
            ${requests.map(req => {
              let actionButtons = '';

              switch(req.status){
                case 'pending':
                  actionButtons = `
                    <button onclick="handleRequest('${req._id}','approved')" class="px-3 py-1 bg-green-600 text-white rounded mt-1">Approve</button>
                    <button onclick="handleRequest('${req._id}','ignored')" class="px-3 py-1 bg-red-600 text-white rounded mt-1">Ignore</button>
                    <button onclick="handleRequest('${req._id}','chat')" class="px-3 py-1 bg-indigo-600 text-white rounded mt-1">Chat Online</button>
                    <button onclick="requestMeeting('${req._id}')" class="px-3 py-1 bg-yellow-500 text-white rounded mt-1">
                      Request Meeting
                    </button>
                  `;
                  break;

                case 'approved':
                  actionButtons = `
                    <button onclick="handleRequest('${req._id}','chat')" class="px-3 py-1 bg-indigo-600 text-white rounded mt-1">Chat Online</button>
                    <button onclick="requestMeeting('${req._id}')" class="px-3 py-1 bg-yellow-500 text-white rounded mt-1">Request Meeting</button>
                  `;
                  break;

                case 'chat':
                  actionButtons = `
                    <button onclick="handleRequest('${req._id}','finalized')" class="px-3 py-1 bg-green-700 text-white rounded mt-1">Finalize Adoption</button>
                  `;
                  break;

                case 'ignored':
                case 'rejected':
                case 'finalized':
                case 'meeting': 
                  actionButtons = `<span class="text-gray-500 italic">${req.status.charAt(0).toUpperCase() + req.status.slice(1)}</span>`;
                  break;

                default:
                  actionButtons = `<span class="text-gray-500 italic">${req.status}</span>`;
              }

              return `
                <div class="bg-white p-4 rounded shadow">
                  <h3 class="font-semibold text-indigo-700">${req.pet.name} (${req.pet.breed})</h3>
                  <p>Adopter: ${req.adopter.name} (${req.adopter.email})</p>
                  <p>Location: ${req.adopter.location}</p>
                  <p>Status: <b>${req.status}</b></p>
                  <div class="flex flex-wrap gap-2 mt-2">${actionButtons}</div>
                </div>
              `;
            }).join("")}
          </div>
        `;

      } catch(err){
        console.error(err);
        displayMessage("Failed to load adoption requests", true);
      }
    }; 


    // handle approval/ignore
    const handleRequest = async (requestId, action) => {
      try {
        const res = await fetchWithAuth(`${ADOPTIONS_API_URL}/${requestId}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: action })
        });
        const data = await res.json();
        if(res.ok){
          displayMessage(`Request status updated to ${action}`);
          await loadStaffRequests(); // refresh list
          await loadUserAndDashboard(); // refresh pet list too (e.g., if finalized)
        } else displayMessage(data.msg || 'Failed to update request', true);
      } catch(err){
        console.error(err);
        displayMessage('Server error', true);
      }
    }

    function updateRequestStatus(requestId, status) {
      fetch(`${ADOPTION_API_BASE_URL}/${requestId}/status`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'x-auth-token': token
      },
      body: JSON.stringify({ status })
    })
    .then(async res => {
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch {
        throw new Error(text || `Server error: ${res.status}`);
      }
    })
    .then(data => {
      displayMessage(data.msg || "Updated");
      loadStaffRequests();
    })
    .catch(err => {
        console.error("Update error:", err);
        displayMessage(`Update failed: ${err.message}`, true);
    });
    }

    // request meeting handler
    async function requestMeeting(requestId) {
      const meetingDate = prompt("Enter meeting date & time (YYYY-MM-DDTHH:MM)\nExample: 2025-10-03T14:00");
      if (!meetingDate) return;

      try {
        const res = await fetch(`${ADOPTIONS_API_URL}/${requestId}/status`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        "x-auth-token": token,
      },
      body: JSON.stringify({ status: 'meeting', meetingDate }),
    });

        const data = await res.json();
        if (res.ok) {
          displayMessage("Meeting requested successfully!");
          await loadStaffRequests(); // refresh the staff view
        } else {
          displayMessage("Failed to request meeting: " + (data.msg || 'Unknown error'), true);
        }
      } catch (err) {
        console.error(err);
        displayMessage("Error requesting meeting", true);
      }
    }

    // ------------------------
    // Logout
    // ------------------------
    document.getElementById("logoutBtn").addEventListener("click",()=>{localStorage.removeItem("token"); window.location.href="index.html";});

    document.addEventListener("DOMContentLoaded", loadUserAndDashboard);
  </script>
</body>
</html>