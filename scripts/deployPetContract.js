require('dotenv').config();
const { Web3 } = require('web3');
const HDWalletProvider = require('@truffle/hdwallet-provider');

async function deployPetContract() {
  console.log(' DEPLOYING PET ADOPTION SMART CONTRACT...\n');
  
  try {
    const provider = new HDWalletProvider({
      privateKeys: [process.env.WALLET_PRIVATE_KEY],
      providerOrUrl: `https://sepolia.infura.io/v3/${process.env.INFURA_PROJECT_ID}`
    });

    const web3 = new Web3(provider);
    
    const accounts = await web3.eth.getAccounts();
    const deployer = accounts[0];
    const balance = await web3.eth.getBalance(deployer);
    
    console.log(' Deployment Details:');
    console.log('   Deployer:', deployer);
    console.log('   Balance:', web3.utils.fromWei(balance, 'ether'), 'ETH');
    console.log('   Network: Sepolia Testnet');

    // Smart contract ABI and bytecode
    const contractABI = [
      "constructor()",
      "event AdoptionRecorded(string indexed petId, address indexed adopter, address indexed shelter, uint256 timestamp, string petName)",
      "function adoptionRecords(string) view returns (string petId, string petName, string breed, uint256 timestamp, address adopter, address shelter, string healthSummary, string trainingSummary)",
      "function getAdoptionRecord(string _petId) view returns (string, string, uint256, address, address, string)",
      "function owner() view returns (address)",
      "function petAdopted(string) view returns (bool)",
      "function recordAdoption(string _petId, string _petName, string _breed, address _adopter, string _healthSummary, string _trainingSummary) returns (bool)",
      "function totalAdoptions() view returns (uint256)",
      "function verifyAdoption(string _petId) view returns (bool)"
    ];

    const contractBytecode = '0x608060405234801561001057600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555061171e806100606000396000f3fe608060405234801561001057600080fd5b506004361061007d5760003560e01c8063927047be1161005b578063927047be146100f5578063deacbe7014610125578063e1a0405014610155578063e6f612e7146101855761007d565b806340770d32146100825780636a5eb079146100b95780638da5cb5b146100d7575b600080fd5b61009c60048036038101906100979190610e4e565b6101ba565b6040516100b0989796959493929190610f70565b60405180910390f35b6100c1610500565b6040516100ce9190611011565b60405180910390f35b6100df610506565b6040516100ec919061102c565b60405180910390f35b61010f600480360381019061010a9190610e4e565b61052a565b60405161011c9190611062565b60405180910390f35b61013f600480360381019061013a9190610e4e565b61055f565b60405161014c9190611062565b60405180910390f35b61016f600480360381019061016a91906110a9565b610595565b60405161017c9190611062565b60405180910390f35b61019f600480360381019061019a9190610e4e565b6108f8565b6040516101b1969594939291906111c2565b60405180910390f35b6002818051602081018201805184825260208301602085012081835280955050505050506000915090508060000180546101f390611267565b80601f016020809104026020016040519081016040528092919081815260200182805461021f90611267565b801561026c5780601f106102415761010080835404028352916020019161026c565b820191906000526020600020905b81548152906001019060200180831161024f57829003601f168201915b50505050509080600101805461028190611267565b80601f01602080910402602001604051908101604052809291908181526020018280546102ad90611267565b80156102fa5780601f106102cf576101008083540402835291602001916102fa565b820191906000526020600020905b8154815290600101906020018083116102dd57829003601f168201915b50505050509080600201805461030f90611267565b80601f016020809104026020016040519081016040528092919081815260200182805461033b90611267565b80156103885780601f1061035d57610100808354040283529160200191610388565b820191906000526020600020905b81548152906001019060200180831161036b57829003601f168201915b5050505050908060030154908060040160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060050160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060060180546103ef90611267565b80601f016020809104026020016040519081016040528092919081815260200182805461041b90611267565b80156104685780601f1061043d57610100808354040283529160200191610468565b820191906000526020600020905b81548152906001019060200180831161044b57829003601f168201915b50505050509080600701805461047d90611267565b80601f01602080910402602001604051908101604052809291908181526020018280546104a990611267565b80156104f65780601f106104cb576101008083540402835291602001916104f6565b820191906000526020600020905b8154815290600101906020018083116104d957829003601f168201915b5050505050905088565b60015481565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600060038260405161053c91906112d4565b908152602001604051809103902060009054906101000a900460ff169050919050565b6003818051602081018201805184825260208301602085012081835280955050505050506000915054906101000a900460ff1681565b60006003876040516105a791906112d4565b908152602001604051809103902060009054906101000a900460ff1615610603576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105fa90611337565b60405180910390fd5b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610691576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610688906113a3565b60405180910390fd5b6040518061010001604052808881526020018781526020018681526020014281526020018573ffffffffffffffffffffffffffffffffffffffff1681526020013373ffffffffffffffffffffffffffffffffffffffff1681526020018481526020018381525060028860405161070791906112d4565b9081526020016040518091039020600082015181600001908161072a919061156f565b506020820151816001019081610740919061156f565b506040820151816002019081610756919061156f565b506060820151816003015560808201518160040160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060a08201518160050160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060c0820151816006019081610804919061156f565b5060e082015181600701908161081a919061156f565b50905050600160038860405161083091906112d4565b908152602001604051809103902060006101000a81548160ff0219169083151502179055506001600081548092919061086890611670565b91905055503373ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff16886040516108a991906112d4565b60405180910390207f8cb6175963f6b581c5e09ef48fb3752936b5a9614770db5f2127d7ee6fc7ccb0428a6040516108e29291906116b8565b60405180910390a4600190509695505050505050565b60608060008060006060600060028860405161091491906112d4565b90815260200160405180910390206040518061010001604052908160008201805461093e90611267565b80601f016020809104026020016040519081016040528092919081815260200182805461096a90611267565b80156109b75780601f1061098c576101008083540402835291602001916109b7565b820191906000526020600020905b81548152906001019060200180831161099a57829003601f168201915b505050505081526020016001820180546109d090611267565b80601f01602080910402602001604051908101604052809291908181526020018280546109fc90611267565b8015610a495780601f10610a1e57610100808354040283529160200191610a49565b820191906000526020600020905b815481529060010190602001808311610a2c57829003601f168201915b50505050508152602001600282018054610a6290611267565b80601f0160208091040260200160405190810160405280929190818152602001828054610a8e90611267565b8015610adb5780601f10610ab057610100808354040283529160200191610adb565b820191906000526020600020905b815481529060010190602001808311610abe57829003601f168201915b50505050508152602001600382015481526020016004820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016005820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001600682018054610baa90611267565b80601f0160208091040260200160405190810160405280929190818152602001828054610bd690611267565b8015610c235780601f10610bf857610100808354040283529160200191610c23565b820191906000526020600020905b815481529060010190602001808311610c0657829003601f168201915b50505050508152602001600782018054610c3c90611267565b80601f0160208091040260200160405190810160405280929190818152602001828054610c6890611267565b8015610cb55780601f10610c8a57610100808354040283529160200191610cb5565b820191906000526020600020905b815481529060010190602001808311610c9857829003601f168201915b505050505081525050905080600001518160400151826060015183608001518460a001518560c001519650965096509650965096505091939550919395565b6000604051905090565b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b610d5b82610d12565b810181811067ffffffffffffffff82111715610d7a57610d79610d23565b5b80604052505050565b6000610d8d610cf4565b9050610d998282610d52565b919050565b600067ffffffffffffffff821115610db957610db8610d23565b5b610dc282610d12565b9050602081019050919050565b82818337600083830152505050565b6000610df1610dec84610d9e565b610d83565b905082815260208101848484011115610e0d57610e0c610d0d565b5b610e18848285610dcf565b509392505050565b600082601f830112610e3557610e34610d08565b5b8135610e45848260208601610dde565b91505092915050565b600060208284031215610e6457610e63610cfe565b5b600082013567ffffffffffffffff811115610e8257610e81610d03565b5b610e8e84828501610e20565b91505092915050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610ed1578082015181840152602081019050610eb6565b60008484015250505050565b6000610ee882610e97565b610ef28185610ea2565b9350610f02818560208601610eb3565b610f0b81610d12565b840191505092915050565b6000819050919050565b610f2981610f16565b82525050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610f5a82610f2f565b9050919050565b610f6a81610f4f565b82525050565b6000610100820190508181036000830152610f8b818b610edd565b90508181036020830152610f9f818a610edd565b90508181036040830152610fb38189610edd565b9050610fc26060830188610f20565b610fcf6080830187610f61565b610fdc60a0830186610f61565b81810360c0830152610fee8185610edd565b905081810360e08301526110028184610edd565b90509998505050505050505050565b60006020820190506110266000830184610f20565b92915050565b60006020820190506110416000830184610f61565b92915050565b60008115159050919050565b61105c81611047565b82525050565b60006020820190506110776000830184611053565b92915050565b61108681610f4f565b811461109157600080fd5b50565b6000813590506110a38161107d565b92915050565b60008060008060008060c087890312156110c6576110c5610cfe565b5b600087013567ffffffffffffffff8111156110e4576110e3610d03565b5b6110f089828a01610e20565b965050602087013567ffffffffffffffff81111561111157611110610d03565b5b61111d89828a01610e20565b955050604087013567ffffffffffffffff81111561113e5761113d610d03565b5b61114a89828a01610e20565b945050606061115b89828a01611094565b935050608087013567ffffffffffffffff81111561117c5761117b610d03565b5b61118889828a01610e20565b92505060a087013567ffffffffffffffff8111156111a9576111a8610d03565b5b6111b589828a01610e20565b9150509295509295509295565b600060c08201905081810360008301526111dc8189610edd565b905081810360208301526111f08188610edd565b90506111ff6040830187610f20565b61120c6060830186610f61565b6112196080830185610f61565b81810360a083015261122b8184610edd565b9050979650505050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061127f57607f821691505b60208210810361129257611291611238565b5b50919050565b600081905092915050565b60006112ae82610e97565b6112b88185611298565b93506112c8818560208601610eb3565b80840191505092915050565b60006112e082846112a3565b915081905092915050565b7f50657420616c72656164792061646f7074656400000000000000000000000000600082015250565b6000611321601383610ea2565b915061132c826112eb565b602082019050919050565b6000602082019050818103600083015261135081611314565b9050919050565b7f4f6e6c79206f776e65722063616e207265636f72642061646f7074696f6e7300600082015250565b600061138d601f83610ea2565b915061139882611357565b602082019050919050565b600060208201905081810360008301526113bc81611380565b9050919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026114257fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826113e8565b61142f86836113e8565b95508019841693508086168417925050509392505050565b6000819050919050565b600061146c61146761146284610f16565b611447565b610f16565b9050919050565b6000819050919050565b61148683611451565b61149a61149282611473565b8484546113f5565b825550505050565b600090565b6114af6114a2565b6114ba81848461147d565b505050565b5b818110156114de576114d36000826114a7565b6001810190506114c0565b5050565b601f821115611523576114f4816113c3565b6114fd846113d8565b8101602085101561150c578190505b611520611518856113d8565b8301826114bf565b50505b505050565b600082821c905092915050565b600061154660001984600802611528565b1980831691505092915050565b600061155f8383611535565b9150826002028217905092915050565b61157882610e97565b67ffffffffffffffff81111561159157611590610d23565b5b61159b8254611267565b6115a68282856114e2565b600060209050601f8311600181146115d957600084156115c7578287015190505b6115d18582611553565b865550611639565b601f1984166115e7866113c3565b60005b8281101561160f578489015182556001820191506020850194506020810190506115ea565b8683101561162c5784890151611628601f891682611535565b8355505b6001600288020188555050505b505050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061167b82610f16565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82036116ad576116ac611641565b5b600182019050919050565b60006040820190506116cd6000830185610f20565b81810360208301526116df8184610edd565b9050939250505056fea2646970667358221220e7f960e6bc7f1b77d777ae6b3e199ec8678cd4141f5b3fea91c1c7cb3c78d06c64736f6c63430008130033';

    console.log('\n Deploying contract...');
    
    const PetContract = new web3.eth.Contract(contractABI);
    
    const deployment = PetContract.deploy({
      data: contractBytecode,
      arguments: []
    });

    const gasEstimate = await deployment.estimateGas({ from: deployer });
    const gasPrice = await web3.eth.getGasPrice();
    
    console.log('   Gas Estimate:', gasEstimate);
    console.log('   Gas Price:', web3.utils.fromWei(gasPrice, 'gwei'), 'Gwei');
    
    const deployedContract = await deployment.send({
      from: deployer,
      gas: gasEstimate,
      gasPrice: gasPrice
    });

    console.log('\n CONTRACT DEPLOYED SUCCESSFULLY!');
    console.log('══════════════════════════════════════');
    console.log(' Contract Address:', deployedContract.options.address);
    console.log('Transaction Hash:', deployedContract.transactionHash);
    console.log('Explorer: https://sepolia.etherscan.io/address/' + deployedContract.options.address);
    console.log('══════════════════════════════════════\n');

    // Save contract address to .env
    console.log('Add this to your .env file:');
    console.log('CONTRACT_ADDRESS=' + deployedContract.options.address);

    return deployedContract.options.address;
    provider.engine.stop();
    
  } catch (error) {
    console.log('Contract deployment failed:', error.message);
    return null;
  }
}

deployPetContract();