<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browse Pets - Find Your Perfect Companion</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Navigation -->
  <nav class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <h1 class="text-xl font-bold text-indigo-700">PetConnect</h1>
        </div>
        <div class="flex items-center space-x-4">
          <button onclick="window.location.href='user-profile.html'" 
                  class="text-gray-700 hover:text-indigo-600">
            My Profile
          </button>
          <button onclick="window.location.href='user-listings.html'" 
                  class="text-gray-700 hover:text-indigo-600">
            My Listings
          </button>
          <button id="logoutBtn" 
                  class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
            Logout
          </button>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">Find Your Perfect Companion</h1>
      <p class="text-lg text-gray-600">Browse pets available for adoption or fostering</p>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
      <div class="flex flex-wrap gap-4 items-center">
        <!-- Type Filter -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">I want to:</label>
          <select id="typeFilter" class="border rounded-lg px-4 py-2 min-w-[200px]">
            <option value="all">See All Pets</option>
            <option value="adoption">Adopt a Pet</option>
            <option value="fostering">Foster a Pet</option>
          </select>
        </div>

        <!-- Search -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Search:</label>
          <input type="text" id="searchFilter" placeholder="Name, breed, description..." 
                 class="border rounded-lg px-4 py-2 min-w-[300px]">
        </div>

        <!-- Location -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Location:</label>
          <input type="text" id="locationFilter" placeholder="City, state..." 
                 class="border rounded-lg px-4 py-2 min-w-[200px]">
        </div>

        <!-- Buttons -->
        <div class="flex items-end gap-2">
          <button id="applyFilters" 
                  class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
            Apply Filters
          </button>
          <button id="clearFilters" 
                  class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
            Clear
          </button>
        </div>
      </div>
    </div>

    <!-- Results Count -->
    <div id="resultsInfo" class="mb-4 text-gray-600">
      Loading pets...
    </div>

    <!-- Pets Grid -->
    <div id="petsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
      <!-- Pets will be loaded here -->
    </div>

    <!-- No Results -->
    <div id="noResults" class="text-center py-12 hidden">
      <p class="text-gray-500 text-lg">No pets found matching your criteria.</p>
      <button id="resetSearch" class="mt-4 text-indigo-600 hover:text-indigo-800">
        Reset filters and try again
      </button>
    </div>

    <!-- Loading -->
    <div id="loading" class="text-center py-8">
      <p class="text-gray-500">Loading pets...</p>
    </div>
  </div>

  <!-- Result Message -->
  <div id="resultMessage" class="fixed top-4 right-4 p-4 rounded-lg shadow-lg hidden"></div>

  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'index.html';
    }

    let currentFilters = {
      type: 'all',
      search: '',
      location: ''
    };

    // DOM Elements
    const petsContainer = document.getElementById('petsContainer');
    const resultsInfo = document.getElementById('resultsInfo');
    const noResults = document.getElementById('noResults');
    const loading = document.getElementById('loading');

    // Load pets on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadPets();
      setupEventListeners();
    });

    function setupEventListeners() {
      // Filter changes
      document.getElementById('applyFilters').addEventListener('click', applyFilters);
      document.getElementById('clearFilters').addEventListener('click', clearFilters);
      document.getElementById('resetSearch').addEventListener('click', clearFilters);
      
      // Enter key in search
      document.getElementById('searchFilter').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') applyFilters();
      });
    }

    function applyFilters() {
      currentFilters = {
        type: document.getElementById('typeFilter').value,
        search: document.getElementById('searchFilter').value,
        location: document.getElementById('locationFilter').value
      };
      loadPets();
    }

    function clearFilters() {
      document.getElementById('typeFilter').value = 'all';
      document.getElementById('searchFilter').value = '';
      document.getElementById('locationFilter').value = '';
      currentFilters = { type: 'all', search: '', location: '' };
      loadPets();
    }

    async function loadPets() {
      showLoading();
      
      try {
        // Build query string
        const params = new URLSearchParams();
        if (currentFilters.type !== 'all') params.append('type', currentFilters.type);
        if (currentFilters.search) params.append('search', currentFilters.search);
        if (currentFilters.location) params.append('location', currentFilters.location);

        const response = await fetch(`http://localhost:5001/api/pets/browse/all?${params}`, {
          headers: {
            'Content-Type': 'application/json',
            'x-auth-token': token
          }
        });

        const result = await response.json();

        if (response.ok) {
          displayPets(result.pets, result.total);
        } else {
          showError(result.msg || 'Failed to load pets');
        }
      } catch (error) {
        console.error('Error loading pets:', error);
        showError('Network error. Please try again.');
      }
    }

    function displayPets(pets, total) {
      hideLoading();

      if (pets.length === 0) {
        petsContainer.innerHTML = '';
        noResults.classList.remove('hidden');
        resultsInfo.textContent = 'No pets found';
        return;
      }

      noResults.classList.add('hidden');
      resultsInfo.textContent = `Found ${total} pet${total !== 1 ? 's' : ''}`;

      petsContainer.innerHTML = pets.map(pet => `
        <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow">
          ${pet.images && pet.images.length > 0 && pet.images[0].url ? 
            `<img src="${pet.images[0].url}" 
                  class="w-full h-48 object-cover cursor-pointer"
                  onclick="viewPetDetail('${pet._id}')"
                  onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">` :
            `<div class="w-full h-48 bg-gray-200 flex items-center justify-center text-gray-500 cursor-pointer"
                 onclick="viewPetDetail('${pet._id}')">
               No Image
             </div>`
          }
          
          <div class="p-4">
            <!-- Badges -->
            <div class="flex justify-between items-start mb-2">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                ${pet.listingType === 'shelter' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                ${pet.listingType === 'shelter' ? 'üè† Shelter Pet' : 'üë§ Personal Listing'}
              </span>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                ${getStatusDisplay(pet.status)}
              </span>
            </div>

            <!-- Pet Info -->
            <h3 class="text-lg font-semibold text-gray-900 mb-1">${pet.name}</h3>
            <p class="text-sm text-gray-600 mb-1">${pet.breed || 'Mixed Breed'} ‚Ä¢ ${pet.age || 'N/A'} years</p>
            <p class="text-sm text-gray-600 mb-2">üìç ${pet.location || 'Location not specified'}</p>
            
            <p class="text-sm text-gray-700 mb-4 line-clamp-2">${pet.description || 'No description available.'}</p>

            <!-- Action Buttons -->
            <div class="flex gap-2">
              ${pet.listingType === 'shelter' ? `
                <button onclick="adoptPet('${pet._id}')" 
                        class="flex-1 bg-indigo-600 text-white py-2 px-3 rounded-lg text-sm hover:bg-indigo-700">
                  Adopt
                </button>
                <button onclick="fosterPet('${pet._id}')" 
                        class="flex-1 bg-green-600 text-white py-2 px-3 rounded-lg text-sm hover:bg-green-700">
                  Foster
                </button>
              ` : `
                <button onclick="fosterPet('${pet._id}')" 
                        class="flex-1 bg-green-600 text-white py-2 px-3 rounded-lg text-sm hover:bg-green-700">
                  Offer to Foster
                </button>
              `}
              
              <button onclick="addToFavorites('${pet._id}')" 
                      class="bg-gray-200 text-gray-700 p-2 rounded-lg hover:bg-gray-300">
                ‚ô°
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function getStatusDisplay(status) {
      const statusMap = {
        'Available': 'Available',
        'available_fostering': 'Available for Foster',
        'Pending Adoption': 'Pending Adoption',
        'Pending Foster': 'Pending Foster',
        'pending_foster': 'Pending Foster',
        'Adopted': 'Adopted',
        'Fostered': 'Fostered'
      };
      return statusMap[status] || status;
    }

    // Action Functions
    async function adoptPet(petId) {
      if (!confirm('Are you sure you want to adopt this pet?')) return;
      
      try {
        const response = await fetch(`http://localhost:5001/api/pets/${petId}/adopt`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-auth-token': token
          }
        });

        const result = await response.json();
        
        if (response.ok) {
          showMessage('Adoption request submitted successfully!', 'success');
          loadPets(); // Refresh the list
        } else {
          showMessage(result.msg || 'Failed to submit adoption request', 'error');
        }
      } catch (error) {
        console.error('Adoption error:', error);
        showMessage('Network error. Please try again.', 'error');
      }
    }

    // async function fosterPet(petId) {
    //   if (!confirm('Are you sure you want to foster this pet?')) return;
      
    //   try {
    //     const response = await fetch(`http://localhost:5001/api/pets/${petId}/foster`, {
    //       method: 'POST',
    //       headers: {
    //         'Content-Type': 'application/json',
    //         'x-auth-token': token
    //       }
    //     });

    //     const result = await response.json();
        
    //     if (response.ok) {
    //       showMessage('Foster request submitted successfully!', 'success');
    //       loadPets(); // Refresh the list
    //     } else {
    //       showMessage(result.msg || 'Failed to submit foster request', 'error');
    //     }
    //   } catch (error) {
    //     console.error('Foster error:', error);
    //     showMessage('Network error. Please try again.', 'error');
    //   }
    // }

    // Replace your current fosterPet function with this:
async function fosterPet(petId) {
  const message = prompt("Why would you like to foster this pet? (Optional)");
  
  try {
    const response = await fetch(`http://localhost:5001/api/pets/${petId}/foster`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-auth-token': token
      },
      body: JSON.stringify({ message })
    });

    const result = await response.json();
    
    if (response.ok) {
      showMessage(result.msg || 'Foster request submitted successfully!', 'success');
    } else {
      showMessage(result.msg || 'Failed to submit foster request', 'error');
    }
  } catch (error) {
    console.error('Foster error:', error);
    showMessage('Network error. Please try again.', 'error');
  }
}



    async function addToFavorites(petId) {
      try {
        const response = await fetch(`http://localhost:5001/api/users/favorites/${petId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-auth-token': token
          }
        });

        const result = await response.json();
        
        if (response.ok) {
          showMessage('Added to favorites!', 'success');
        } else {
          showMessage(result.msg || 'Failed to add to favorites', 'error');
        }
      } catch (error) {
        console.error('Favorite error:', error);
        showMessage('Network error. Please try again.', 'error');
      }
    }

    function viewPetDetail(petId) {
      // You can implement a detailed pet view modal or page
      alert(`Viewing details for pet ${petId}. Implement detailed view here.`);
    }

    // UI Helper Functions
    function showLoading() {
      loading.classList.remove('hidden');
      petsContainer.innerHTML = '';
    }

    function hideLoading() {
      loading.classList.add('hidden');
    }

    function showMessage(message, type) {
      const messageDiv = document.getElementById('resultMessage');
      messageDiv.textContent = message;
      messageDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
      }`;
      messageDiv.classList.remove('hidden');
      
      setTimeout(() => {
        messageDiv.classList.add('hidden');
      }, 4000);
    }

    function showError(message) {
      showMessage(message, 'error');
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      window.location.href = 'index.html';
    });

  </script>
</body>
</html>