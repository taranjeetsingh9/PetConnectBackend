<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browse Pets - Find Your Perfect Companion</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
  <!-- Navigation -->
  <nav class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <div class="flex items-center space-x-3">
            <div class="bg-indigo-600 text-white p-2 rounded-lg">
              <i class="fas fa-paw text-xl"></i>
            </div>
            <h1 class="text-xl font-bold text-gray-900">PetConnect</h1>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <button onclick="window.location.href='user-profile.html'" 
                  class="bg-white border border-gray-300 rounded-lg px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors flex items-center space-x-2">
            <i class="fas fa-user-circle"></i>
            <span>My Profile</span>
          </button>
          <button onclick="window.location.href='user-listings.html'" 
                  class="bg-white border border-gray-300 rounded-lg px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors flex items-center space-x-2">
            <i class="fas fa-list"></i>
            <span>My Listings</span>
          </button>
          <button onclick="window.location.href='my-foster-requests.html'" 
          class="bg-white border border-gray-300 rounded-lg px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors flex items-center space-x-2">
    <i class="fas fa-list"></i>
    <span>My Foster Request</span>
  </button>
          <button id="logoutBtn" 
                  class="bg-red-500 text-white rounded-lg px-4 py-2 hover:bg-red-600 transition-colors flex items-center space-x-2">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">Find Your Perfect Companion</h1>
      <p class="text-lg text-gray-600">Browse pets available for adoption or fostering in your area</p>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-8">
      <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-filter text-indigo-600 mr-2"></i>
        Filter Pets
      </h2>
      <div class="flex flex-wrap gap-6 items-end">
        <!-- Type Filter -->
        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm font-medium text-gray-700 mb-2">I want to:</label>
          <select id="typeFilter" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
            <option value="all">See All Pets</option>
            <option value="adoption">Adopt a Pet</option>
            <option value="fostering">Foster a Pet</option>
          </select>
        </div>

        <!-- Search -->
        <div class="flex-1 min-w-[300px]">
          <label class="block text-sm font-medium text-gray-700 mb-2">Search:</label>
          <div class="relative">
            <input type="text" id="searchFilter" placeholder="Name, breed, description..." 
                   class="w-full border border-gray-300 rounded-lg px-4 py-3 pl-10 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          </div>
        </div>

        <!-- Location -->
        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm font-medium text-gray-700 mb-2">Location:</label>
          <div class="relative">
            <input type="text" id="locationFilter" placeholder="City, state..." 
                   class="w-full border border-gray-300 rounded-lg px-4 py-3 pl-10 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
            <i class="fas fa-map-marker-alt absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          </div>
        </div>

        <!-- Buttons -->
        <div class="flex items-end gap-3">
          <button id="applyFilters" 
                  class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition-colors flex items-center space-x-2">
            <i class="fas fa-check"></i>
            <span>Apply Filters</span>
          </button>
          <button id="clearFilters" 
                  class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors flex items-center space-x-2">
            <i class="fas fa-times"></i>
            <span>Clear</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Results Count -->
    <div id="resultsInfo" class="mb-4 text-gray-600 bg-white rounded-lg p-4 shadow-sm">
      <div class="flex items-center">
        <i class="fas fa-paw text-indigo-600 mr-2"></i>
        <span>Loading pets...</span>
      </div>
    </div>

    <!-- Pets Grid -->
    <div id="petsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
      <!-- Pets will be loaded here -->
    </div>

    <!-- No Results -->
    <div id="noResults" class="text-center py-12 hidden">
      <div class="bg-white rounded-2xl p-8 shadow-sm">
        <i class="fas fa-search text-5xl text-gray-300 mb-4"></i>
        <p class="text-gray-500 text-lg mb-2">No pets found matching your criteria.</p>
        <p class="text-gray-400 text-sm mb-4">Try adjusting your filters or search terms</p>
        <button id="resetSearch" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
          Reset filters and try again
        </button>
      </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="text-center py-8">
      <div class="bg-white rounded-2xl p-8 shadow-sm">
        <div class="flex flex-col items-center">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
          <p class="text-gray-500">Loading pets...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Result Message -->
  <div id="resultMessage" class="fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 hidden"></div>

  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'index.html';
    }

    let currentFilters = {
      type: 'all',
      search: '',
      location: ''
    };

    // DOM Elements
    const petsContainer = document.getElementById('petsContainer');
    const resultsInfo = document.getElementById('resultsInfo');
    const noResults = document.getElementById('noResults');
    const loading = document.getElementById('loading');

    // Load pets on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadPets();
      setupEventListeners();
    });

    function setupEventListeners() {
      // Filter changes
      document.getElementById('applyFilters').addEventListener('click', applyFilters);
      document.getElementById('clearFilters').addEventListener('click', clearFilters);
      document.getElementById('resetSearch').addEventListener('click', clearFilters);
      
      // Enter key in search
      document.getElementById('searchFilter').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') applyFilters();
      });
    }

    function applyFilters() {
      currentFilters = {
        type: document.getElementById('typeFilter').value,
        search: document.getElementById('searchFilter').value,
        location: document.getElementById('locationFilter').value
      };
      loadPets();
    }

    function clearFilters() {
      document.getElementById('typeFilter').value = 'all';
      document.getElementById('searchFilter').value = '';
      document.getElementById('locationFilter').value = '';
      currentFilters = { type: 'all', search: '', location: '' };
      loadPets();
    }

    async function loadPets() {
      showLoading();
      
      try {
        // Build query string
        const params = new URLSearchParams();
        if (currentFilters.type !== 'all') params.append('type', currentFilters.type);
        if (currentFilters.search) params.append('search', currentFilters.search);
        if (currentFilters.location) params.append('location', currentFilters.location);

        const response = await fetch(`http://localhost:5001/api/pets/browse/all?${params}`, {
          headers: {
            'Content-Type': 'application/json',
            'x-auth-token': token
          }
        });

        const result = await response.json();

        if (response.ok) {
          displayPets(result.pets, result.total);
        } else {
          showError(result.msg || 'Failed to load pets');
        }
      } catch (error) {
        console.error('Error loading pets:', error);
        showError('Network error. Please try again.');
      }
    }

    function displayPets(pets, total) {
      hideLoading();

      if (pets.length === 0) {
        petsContainer.innerHTML = '';
        noResults.classList.remove('hidden');
        resultsInfo.textContent = 'No pets found';
        return;
      }

      noResults.classList.add('hidden');
      resultsInfo.innerHTML = `
        <div class="flex items-center">
          <i class="fas fa-paw text-indigo-600 mr-2"></i>
          <span>Found ${total} pet${total !== 1 ? 's' : ''} matching your criteria</span>
        </div>
      `;

      petsContainer.innerHTML = pets.map(pet => `
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden hover:shadow-lg transition-all duration-300 border border-gray-200">
          ${pet.images && pet.images.length > 0 && pet.images[0].url ? 
            `<div class="relative">
              <img src="${pet.images[0].url}" 
                   class="w-full h-48 object-cover cursor-pointer"
                   onclick="viewPetDetail('${pet._id}')"
                   onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
              <div class="absolute top-3 left-3">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                  ${pet.listingType === 'shelter' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                  ${pet.listingType === 'shelter' ? '🏠 Shelter' : '👤 Personal'}
                </span>
              </div>
              <div class="absolute top-3 right-3">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                  ${getStatusDisplay(pet.status)}
                </span>
              </div>
            </div>` :
            `<div class="w-full h-48 bg-gradient-to-br from-gray-100 to-gray-200 flex flex-col items-center justify-center text-gray-500 cursor-pointer"
                 onclick="viewPetDetail('${pet._id}')">
               <i class="fas fa-paw text-3xl mb-2"></i>
               <span>No Image Available</span>
             </div>`
          }
          
          <div class="p-5">
            <!-- Pet Info -->
            <h3 class="text-lg font-semibold text-gray-900 mb-1">${pet.name}</h3>
            <div class="flex items-center text-sm text-gray-600 mb-2">
              <i class="fas fa-dog mr-1"></i>
              <span>${pet.breed || 'Mixed Breed'}</span>
              <span class="mx-2">•</span>
              <i class="fas fa-birthday-cake mr-1"></i>
              <span>${pet.age || 'N/A'} years</span>
            </div>
            <div class="flex items-center text-sm text-gray-600 mb-3">
              <i class="fas fa-map-marker-alt mr-1"></i>
              <span>${pet.location || 'Location not specified'}</span>
            </div>
            
            <p class="text-sm text-gray-700 mb-4 line-clamp-2">${pet.description || 'No description available.'}</p>

            <!-- Action Buttons -->
            <div class="flex gap-2">
              ${pet.listingType === 'shelter' ? `
                <button onclick="adoptPet('${pet._id}')" 
                        class="flex-1 bg-indigo-600 text-white py-2 px-3 rounded-lg text-sm hover:bg-indigo-700 transition-colors flex items-center justify-center">
                  <i class="fas fa-home mr-1"></i>
                  Adopt
                </button>
                <button onclick="fosterPet('${pet._id}')" 
                        class="flex-1 bg-green-600 text-white py-2 px-3 rounded-lg text-sm hover:bg-green-700 transition-colors flex items-center justify-center">
                  <i class="fas fa-heart mr-1"></i>
                  Foster
                </button>
              ` : `
                <button onclick="fosterPet('${pet._id}')" 
                        class="flex-1 bg-green-600 text-white py-2 px-3 rounded-lg text-sm hover:bg-green-700 transition-colors flex items-center justify-center">
                  <i class="fas fa-heart mr-1"></i>
                  Offer to Foster
                </button>
              `}
              
              <button onclick="addToFavorites('${pet._id}')" 
                      class="bg-gray-100 text-gray-700 p-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center justify-center">
                <i class="far fa-heart"></i>
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function getStatusDisplay(status) {
      const statusMap = {
        'Available': 'Available',
        'available_fostering': 'Available for Foster',
        'Pending Adoption': 'Pending Adoption',
        'Pending Foster': 'Pending Foster',
        'pending_foster': 'Pending Foster',
        'Adopted': 'Adopted',
        'Fostered': 'Fostered'
      };
      return statusMap[status] || status;
    }

    // Action Functions
    async function adoptPet(petId) {
      if (!confirm('Are you sure you want to adopt this pet?')) return;
      
      try {
        const response = await fetch(`http://localhost:5001/api/pets/${petId}/adopt`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-auth-token': token
          }
        });

        const result = await response.json();
        
        if (response.ok) {
          showMessage('Adoption request submitted successfully!', 'success');
          loadPets(); // Refresh the list
        } else {
          showMessage(result.msg || 'Failed to submit adoption request', 'error');
        }
      } catch (error) {
        console.error('Adoption error:', error);
        showMessage('Network error. Please try again.', 'error');
      }
    }

    async function fosterPet(petId) {
      const message = prompt("Why would you like to foster this pet? (Optional)");
      
      try {
        const response = await fetch(`http://localhost:5001/api/pets/${petId}/foster`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-auth-token': token
          },
          body: JSON.stringify({ message })
        });

        const result = await response.json();
        
        if (response.ok) {
          showMessage(result.msg || 'Foster request submitted successfully!', 'success');
        } else {
          showMessage(result.msg || 'Failed to submit foster request', 'error');
        }
      } catch (error) {
        console.error('Foster error:', error);
        showMessage('Network error. Please try again.', 'error');
      }
    }

    async function addToFavorites(petId) {
      try {
        const response = await fetch(`http://localhost:5001/api/users/favorites/${petId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-auth-token': token
          }
        });

        const result = await response.json();
        
        if (response.ok) {
          showMessage('Added to favorites!', 'success');
        } else {
          showMessage(result.msg || 'Failed to add to favorites', 'error');
        }
      } catch (error) {
        console.error('Favorite error:', error);
        showMessage('Network error. Please try again.', 'error');
      }
    }

    function viewPetDetail(petId) {
      // You can implement a detailed pet view modal or page
      alert(`Viewing details for pet ${petId}. Implement detailed view here.`);
    }

    // UI Helper Functions
    function showLoading() {
      loading.classList.remove('hidden');
      petsContainer.innerHTML = '';
    }

    function hideLoading() {
      loading.classList.add('hidden');
    }

    function showMessage(message, type) {
      const messageDiv = document.getElementById('resultMessage');
      messageDiv.innerHTML = `
        <div class="flex items-center">
          <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} mr-2"></i>
          <span>${message}</span>
        </div>
      `;
      messageDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
      }`;
      messageDiv.classList.remove('hidden');
      
      setTimeout(() => {
        messageDiv.classList.add('hidden');
      }, 4000);
    }

    function showError(message) {
      showMessage(message, 'error');
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      window.location.href = 'orientation.html';
    });

  </script>

  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .transition-colors {
      transition: background-color 0.2s ease;
    }
    .transition-all {
      transition: all 0.3s ease;
    }
  </style>
</body>
</html>