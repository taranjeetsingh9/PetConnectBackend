<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adopter Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4 sm:p-8">

  <div class="w-full max-w-5xl">
    <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">Adopter Dashboard</h1>

    <!-- Top Bar -->
    <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-md mb-6">
      <p id="userStatus" class="text-lg font-medium text-gray-700"></p>
      <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Sign Out</button>
    </div>

    <!-- Available Pets -->
    <h2 class="text-2xl font-semibold mb-3">Available Pets</h2>
    <div id="petsList" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"></div>

    <!-- My Requests -->
    <h2 class="text-2xl font-semibold mb-3">My Adoption Requests</h2>
    <div id="my-requests" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </div>

  <script>
    const PETS_API_URL = "http://localhost:5001/api/pets";
    const ADOPTIONS_API_URL = "http://localhost:5001/api/adoptions";
    let token = localStorage.getItem("token");

    const fetchWithAuth = (url,opt={})=>{
      return fetch(url,{...opt,headers:{'Content-Type':'application/json','x-auth-token':token,...opt.headers}});
    };

    // Load dashboard
    async function loadDashboard() {
      try {
        // user info
        const userRes = await fetchWithAuth("http://localhost:5001/api/auth/me");
        const user = await userRes.json();
        if(!userRes.ok) return window.location.href="index.html";

        document.getElementById("userStatus").innerText = `Welcome ${user.name}`;

        // fetch pets
        const res = await fetchWithAuth(PETS_API_URL);
        const pets = await res.json();
        renderPets(pets);

        // fetch my requests
        loadMyAdoptionRequests();

      } catch(err){
        console.error(err);
        alert("Failed to load dashboard");
      }
    }

    function renderPets(pets){
      const petsList = document.getElementById("petsList");
      const available = pets.filter(p=>p.status==="Available");
      if(available.length===0){
        petsList.innerHTML = `<p class="col-span-3 text-center text-gray-500">No pets available</p>`;
        return;
      }
      petsList.innerHTML = available.map(pet=>`
        <div class="bg-white border rounded-xl shadow-md overflow-hidden">
          ${pet.images && pet.images[0] ? `<img src="${pet.images[0]}" class="w-full h-48 object-cover">`
          : `<div class="w-full h-48 flex items-center justify-center bg-gray-200 text-gray-500">No Image</div>`}
          <div class="p-4">
            <h3 class="text-lg font-semibold text-indigo-700">${pet.name}</h3>
            <p class="text-sm text-gray-600">Breed: ${pet.breed||"Unknown"}</p>
            <p class="text-sm text-gray-600">Status: ${pet.status}</p>
          </div>
          <button data-id="${pet._id}" class="requestAdoptionBtn w-full bg-green-600 text-white px-3 py-2">Request Adoption</button>
        </div>
      `).join("");
    }

    async function loadMyAdoptionRequests(){
      try{
        const res = await fetchWithAuth(`${ADOPTIONS_API_URL}/my-requests`);
        const requests = await res.json();
        const container = document.getElementById("my-requests");
        container.innerHTML="";

        if(requests.length===0){
          container.innerHTML="<p class='col-span-3 text-center text-gray-500'>No requests yet</p>";
          return;
        }

        requests.forEach(req=>{
          const pet=req.pet;
          const status=req.status;
          const card=document.createElement("div");
          card.className="bg-white border rounded-xl shadow-md p-4";

          card.innerHTML=`
            <h3 class="text-lg font-semibold text-indigo-700">${pet.name}</h3>
            <p class="text-sm text-gray-600">${pet.breed||"Unknown"}</p>
            <p class="mt-2"><b>Status:</b> 
              <span class="px-2 py-1 rounded text-white ${status==='approved'?'bg-green-600':status==='pending'?'bg-yellow-500':'bg-gray-400'}">
                ${status}
              </span>
            </p>
            ${status==='approved'?`<button onclick="startChat('${req._id}')" class="mt-3 w-full bg-blue-600 text-white px-3 py-2 rounded">Chat / Book Meeting</button>`:""}
          `;
          container.appendChild(card);
        });
      }catch(err){console.error(err);}
    }

    // adoption request handler
    document.addEventListener("click", async(e)=>{
      if(e.target.classList.contains("requestAdoptionBtn")){
        const petId = e.target.dataset.id;
        try{
          const res=await fetchWithAuth(`${ADOPTIONS_API_URL}/${petId}/request`,{method:"POST"});
          const data=await res.json();
          if(res.ok){
            alert("Request submitted");
            loadMyAdoptionRequests();
          } else alert(data.msg||"Failed");
        }catch(err){console.error(err);}
      }
    });

    function startChat(reqId){
      alert("Chat/Booking flow coming soon for request "+reqId);
    }

    document.getElementById("logoutBtn").addEventListener("click",()=>{
      localStorage.removeItem("token");
      window.location.href="auth.html";
    });

    document.addEventListener("DOMContentLoaded",loadDashboard);
  </script>
</body>
</html>
